<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xem trước tài liệu</title>
    <style>
      :root {
        color-scheme: light;
        --ink: #0f111a;
        --muted: #6d6f7c;
        --border: rgba(15, 17, 26, 0.12);
        --bg: #f6f7fb;
        --panel: #ffffff;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        color: var(--ink);
        background: var(--bg);
      }
      .bar {
        position: sticky;
        top: 0;
        background: rgba(246, 247, 251, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
        padding: 10px 14px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .title {
        font-weight: 700;
        font-size: 14px;
      }
      .status {
        font-size: 13px;
        color: var(--muted);
      }
      .wrap {
        padding: 14px;
      }
      .frame {
        width: 100%;
        height: calc(100vh - 64px);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: var(--panel);
      }
      iframe {
        width: 100%;
        height: 100%;
        border: 0;
      }
      .error {
        color: #b42318;
      }
    </style>
  </head>
  <body>
    <div class="bar">
      <div class="title">Xem trước tài liệu</div>
      <div id="status" class="status">Đang tải...</div>
    </div>
    <div class="wrap">
      <div class="frame">
        <iframe id="viewer" title="Xem trước" src="about:blank"></iframe>
      </div>
    </div>

    <script>
      (function () {
        const statusEl = document.getElementById('status');
        const iframe = document.getElementById('viewer');

        function setStatus(text, isError) {
          statusEl.textContent = text;
          statusEl.className = 'status' + (isError ? ' error' : '');
        }

        const hash = String(window.location.hash || '').replace(/^#/, '');
        const params = new URLSearchParams(hash);
        const documentId = params.get('documentId') || params.get('id');

        if (!documentId) {
          setStatus('Thiếu documentId', true);
          return;
        }

        const token = localStorage.getItem('accessToken');
        if (!token) {
          setStatus('Bạn cần đăng nhập để xem trước.', true);
          return;
        }

        setStatus('Đang tải file...', false);

        fetch(`/api/documents/${encodeURIComponent(documentId)}/full-preview`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        })
          .then(async (res) => {
            if (!res.ok) {
              let message = `Không tải được file (${res.status})`;
              try {
                const data = await res.json();
                if (data && data.error) {
                  message = data.error;
                }
              } catch (e) {
                // ignore
              }
              throw new Error(message);
            }
            return res.blob();
          })
          .then((blob) => {
            const url = URL.createObjectURL(blob);
            iframe.src = url;
            setStatus('Đã tải xong', false);
            window.addEventListener('beforeunload', () => URL.revokeObjectURL(url));
          })
          .catch((err) => {
            setStatus(err && err.message ? err.message : 'Không tải được file', true);
          });
      })();
    </script>
  </body>
</html>
